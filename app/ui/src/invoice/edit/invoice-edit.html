<import from="../../components/alert/alert"></import>
<import from="./components/invoice-modal"></import>
<import from="./components/invoice-date-modal"></import>
<import from="./components/invoice-payment-modal"></import>
<import from="./components/invoice-customer-modal"></import>
<import from="./components/invoice-attachment-modal"></import>
<import from="./components/validation-result-modal"></import>
<import from="./components/product-name-search"></import>

<invoice-modal component.ref="invoiceModal" invoice-context.bind="invoiceContext" original-document-type.two-way="selectedDocumentType"></invoice-modal>
<invoice-date-modal component.ref="invoiceDateModal" invoice-context.bind="invoiceContext" document-type.bind="selectedDocumentType"></invoice-date-modal>
<invoice-customer-modal component.ref="invoiceCustomerModal" invoice-context.bind="invoiceContext"></invoice-customer-modal>
<invoice-payment-modal component.ref="invoicePaymentModal" invoice-context.bind="invoiceContext"></invoice-payment-modal>
<invoice-attachment-modal component.ref="invoiceAttachmentModal" invoice-context.bind="invoiceContext"></invoice-attachment-modal>
<validation-result-modal component.ref="validationResultModal"></validation-result-modal>

<div class="invoices-main">
    <div class="section-header">
        <div style="display:flex;align-items:center;gap:.5rem">
            <h1 if.bind="!readOnly" style="margin:0" t="invoice.new.${selectedDocumentType}">New Invoice/Credit-Note</h1>
            <h1 else style="margin:0">
                <span t="documentType.${selectedDocumentType}"></span>
                ${invoiceContext.selectedInvoice.ID}
            </h1>
        </div>
        <div class="editor-header-actions">
            <button if.bind="!readOnly" type="button" class="btn" click.trigger="saveAsDraft()">
                <span if.bind="invoiceContext.selectedDraft" t="invoice.edit.update-draft">Update draft</span>
                <span if.bind="!invoiceContext.selectedDraft" t="invoice.edit.save-draft">Save draft</span>
            </button>
            <button if.bind="readOnly" type="button" class="btn" click.trigger="downloadUBL()" t="invoice.edit.download-ubl">Download UBL</button>
            <button type="button" class="btn" click.trigger="validate()" t="invoice.edit.validate">Validate</button>
            <button if.bind="invoiceContext.selectedDraft && !readOnly" type="button" class="btn" click.trigger="deleteDraft()">
                <span t="invoice.edit.delete-draft">Delete draft</span>
            </button>
            <button type="button" class="btn" click.trigger="invoiceContext.clearSelectedInvoice()" t="invoice.edit.discard">Discard</button>
            <button if.bind="!readOnly" type="button" class="btn primary" click.trigger="sendInvoice()" disabled.bind="!isValid" t="invoice.edit.send.${selectedDocumentType}">Send invoice</button>
        </div>
    </div>

    <form id="invoiceForm" class="card composer-card">
        <div  class="composer-head">
            <div class="composer-info">
                <div style="display: flex; flex-direction: row;" click.trigger="showInvoiceModal()">
                    <div class="card-header">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-icon lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                        <h5 style="margin: 0"><span t="documentType.${selectedDocumentType}"></span></h5>
                    </div>

                    <button if.bind="!readOnly" class="icon-btn" title="Edit" t="[title]common.edit">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                    </button>
                </div>
                <div><span t="documentType.${selectedDocumentType}"></span> <span t="invoice.edit.number">Number</span></div>
                <i if.bind="!invoiceContext.selectedInvoice.ID && invoiceContext.lastInvoiceReference" style="color: var(--muted); font-size: var(--space-09)">Last number: ${invoiceContext.lastInvoiceReference}</i>
                <b>${invoiceContext.selectedInvoice.ID}</b>
                <span t="invoice.edit.buyer-reference">Buyer Reference</span>
                <b>${invoiceContext.selectedInvoice.BuyerReference}</b>
            </div>
            <div class="composer-info">
                <div style="display: flex; flex-direction: row;" click.trigger="showDateModal()">
                    <div class="card-header">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days-icon lucide-calendar-days"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                        <h5 style="margin: 0" t="invoice.dateModal.title">Date</h5>
                    </div>

                    <button if.bind="!readOnly" class="icon-btn" title="Edit" t="[title]common.edit">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                    </button>
                </div>
                <span t="invoice.dateModal.issue-date">Issue Date</span>
                <b>${invoiceContext.selectedInvoice.IssueDate}</b>
                <template if.bind="selectedDocumentType === 'INVOICE'">
                    <span t="invoice.dateModal.due-date">Due Date</span>
                    <b>${invoiceContext.selectedInvoice.DueDate}</b>
                </template>
                <template else>
                    <span t="invoice.dateModal.payment-terms">Payment Terms</span>
                    <b>${invoiceContext.selectedInvoice.PaymentTerms.Note}</b>
                </template>
            </div>
            <div class="composer-info">
                <div style="display: flex; flex-direction: row;" click.trigger="showCustomerModal()">
                    <div class="card-header">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building-icon lucide-building"><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M12 6h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/><path d="M8 6h.01"/><path d="M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3"/><rect x="4" y="2" width="16" height="20" rx="2"/></svg>
                        <h5 style="margin: 0" t="invoice.customerModal.title">Customer</h5>
                    </div>

                    <button if.bind="!readOnly" class="icon-btn" title="Edit" t="[title]common.edit">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                    </button>
                </div>
                <span t="label.name">Name</span>
                <b>${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PartyName.Name}</b>
                <span t="label.address">Address</span>
                <b>
                    ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.StreetName}
                    ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.AdditionalStreetName}
                    <br/>
                    ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.CityName}
                    ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.PostalZone}
                </b>
            </div>
            <div class="composer-info">
                <div style="display: flex; flex-direction: row; margin-bottom: var(--space-025)" click.trigger="showPaymentModal()">
                    <div class="card-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-banknote-arrow-down-icon lucide-banknote-arrow-down"><path d="M12 18H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5"/><path d="m16 19 3 3 3-3"/><path d="M18 12h.01"/><path d="M19 16v6"/><path d="M6 12h.01"/><circle cx="12" cy="12" r="2"/></svg>
                        <h5 style="margin: 0" t="invoice.paymentModal.title">Payment</h5>
                    </div>
                    <button if.bind="!readOnly" class="icon-btn" title="Edit" t="[title]common.edit">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                    </button>
                </div>
                <span t="invoice.edit.method">Method</span>
                <b>${invoiceComposer.paymentMeansCodes.find(item => item.value === invoiceContext.selectedInvoice.PaymentMeans.PaymentMeansCode.value).__name ?? 'None'}</b>
                <template if.bind="invoiceContext.selectedInvoice.PaymentMeans.PayeeFinancialAccount">
                    <span t="label.account-name">Account Name</span>
                    <b>${invoiceContext.selectedInvoice.PaymentMeans.PayeeFinancialAccount.Name ?? '/'}</b>
                    <span t="label.iban">IBAN</span>
                    <b>${invoiceContext.selectedInvoice.PaymentMeans.PayeeFinancialAccount.ID ?? '/'}</b>
                </template>
                <template if.bind="invoiceContext.selectedInvoice.PaymentMeans.PaymentID">
                    <span t="label.reference">Reference</span>
                    <b>${invoiceContext.selectedInvoice.PaymentMeans.PaymentID}</b>
                </template>
            </div>
            <div class="composer-info">
                <div style="display: flex; flex-direction: row; margin-bottom: var(--space-025)" click.trigger="showAttachmentModal()">
                    <div class="card-header">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paperclip-icon lucide-paperclip"><path d="m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551"/></svg>
                        <h5 style="margin: 0" t="invoice.edit.attachments">Attachments</h5>
                    </div>
                    <button if.bind="!readOnly" class="icon-btn" title="Edit" t="[title]common.edit">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                    </button>
                </div>
                <template repeat.for="additionalDocumentReference of invoiceContext.selectedInvoice.AdditionalDocumentReference">
                    <button if.bind="additionalDocumentReference.Attachment" class="btn" title.bind="additionalDocumentReference.DocumentDescription" click.trigger="downloadAttachment(additionalDocumentReference.Attachment)">
                        <template if.bind="additionalDocumentReference.Attachment.EmbeddedDocumentBinaryObject">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-down-icon lucide-file-down"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"/><path d="M14 2v5a1 1 0 0 0 1 1h5"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
                            <span>${additionalDocumentReference.Attachment.EmbeddedDocumentBinaryObject.__filename}</span>
                        </template>
                        <template else>
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link2-icon lucide-link-2"><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 1 1 0 10h-2"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                            <span>${additionalDocumentReference.Attachment.ExternalReference.URI}</span>
                        </template>
                    </button>
                </template>
            </div>
            <div class="head-right">
                <div class="total-display">
                    <span t="invoice.edit.subtotal">Subtotal</span>
                    <b>€ ${invoiceContext.selectedInvoice.LegalMonetaryTotal.TaxExclusiveAmount.value.toFixed(2)}</b>
                    <span t="invoice.edit.tax">Tax</span>
                    <b>€ ${invoiceContext.selectedInvoice.TaxTotal[0].TaxAmount.value.toFixed(2)}</b>
                </div>
                <div class="total-display">
                    <span t="invoice.edit.total">Total</span>
                    <strong>€ ${invoiceContext.selectedInvoice.LegalMonetaryTotal.PayableAmount.value.toFixed(2)}</strong>
                </div>
            </div>
        </div>
        <div class="line-items">
            <div class="line-items-head">
                <h3 t="invoice.edit.invoice-lines">Invoice lines</h3>
            </div>
            <div class="table-wrapper">
                <table class="data-table line-table">
                    <thead>
                    <tr>
                        <th style="width:80px">
                            <div style="display: flex">
                                <span t="invoice.edit.pos">Pos</span>
                                <button class="icon-btn" data-action="remove-line" title="Recreate line positions" t="[title]invoice.edit.recreate-positions" click.trigger="recalculateLinePositions()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-restart-icon lucide-list-restart"><path d="M21 5H3"/><path d="M7 12H3"/><path d="M7 19H3"/><path d="M12 18a5 5 0 0 0 9-3 4.5 4.5 0 0 0-4.5-4.5c-1.33 0-2.54.54-3.41 1.41L11 14"/><path d="M11 10v4h4"/></svg>
                                </button>
                            </div>
                        </th>
                        <th style="width:18%" t="product.table.name">Name</th>
                        <th t="product.table.description">Description</th>
                        <th class="num" style="width:120px" t="invoice.edit.amount">Amount</th>
                        <th class="num" style="width:140px" t="invoice.edit.unit-price">Unit price</th>
                        <th class="num" style="width:140px" t="invoice.edit.tax">Tax</th>
                        <th class="num" style="width:140px" t="invoice.edit.total">Total</th>
                        <th if.bind="!readOnly" class="actions-col" style="width:1%" t="invoice.edit.actions">Actions</th>
                    </tr>
                    </thead>
                    <tbody if.bind="invoiceContext.selectedInvoice">
                        <tr repeat.for="line of invoiceContext.lines">
                            <td><input class="pos" type="number" min="1" value.bind="line.ID" required/></td>
                            <td>
                                <product-name-search input-value.two-way="line.Item.Name" readonly.bind="readOnly"></product-name-search>
                            </td>
                            <td><textarea class="description" placeholder="Description" t="[placeholder]label.description" value.bind="line.Item.Description" readonly.bind="readOnly"></textarea></td>
                            <td class="num">
                                <template if.bind="selectedDocumentType === 'INVOICE'">
                                    <input class="qty" type="number" min="0" step="1" value.bind="line.InvoicedQuantity.value" change.trigger="calcLineTotal(line)" readonly.bind="readOnly" />
                                </template>
                                <template else>
                                    <input class="qty" type="number" min="0" step="1" value.bind="line.CreditedQuantity.value" change.trigger="calcLineTotal(line)" readonly.bind="readOnly" />
                                </template>
                            </td>
                            <td class="num"><input class="unitPrice" type="number" min="0" step="0.01" value.bind="line.Price.PriceAmount.value" change.trigger="calcLineTotal(line)" readonly.bind="readOnly" /></td>
                            <td class="num">
                                <select value.bind="line.Item.ClassifiedTaxCategory" change.trigger="calcLineTotal(line)" matcher.bind="taxCategoryMatcher" disabled.bind="readOnly">
                                    <option repeat.for="taxCategory of taxCategories" model.bind="taxCategory">${taxCategory.Percent}%</option>
                                </select>
                            </td>
                            <td class="num"><span class="line-total">€&nbsp;${line.LineExtensionAmount.value}</span></td>
                            <td if.bind="!readOnly" class="actions-col">
                                <button class="icon-btn" data-action="remove-line" title="Remove" t="[title]common.remove" click.trigger="deleteLine(line)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <button if.bind="!readOnly" type="button" class="btn primary" click.trigger="addLine()">+ <span t="invoice.edit.add-line">Add line</span></button>
        <div if.bind="invoiceContext.selectedInvoice.Note" style="margin-top: 20px">
            <div class="line-items-head">
                <h3 t="invoice.edit.note">Note</h3>
            </div>
            <label class="field">
                <textarea name="note" placeholder="Additional notes for this invoice" t="[placeholder]invoice.modal.note-placeholder" value.bind="invoiceContext.selectedInvoice.Note" disabled></textarea>
            </label>
        </div>
    </form>
</div>
