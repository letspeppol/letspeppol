<import from="../../components/alert/alert"></import>
<import from="./components/modals/invoice-modal"></import>
<import from="./components/modals/invoice-date-modal"></import>
<import from="./components/modals/invoice-payment-modal"></import>
<import from="./components/modals/invoice-customer-modal"></import>
<import from="./components/modals/invoice-attachment-modal"></import>
<import from="./components/modals/invoice-number-modal"></import>
<import from="./components/modals/validation-result-modal"></import>
<import from="./components/tiles/customer-info"></import>
<import from="./components/tiles/invoice-info"></import>
<import from="./components/tiles/date-info"></import>
<import from="./components/tiles/payment-info"></import>
<import from="./components/tiles/attachment-info"></import>
<import from="./components/tiles/total-info"></import>
<import from="./components/invoice-edit-items"></import>

<invoice-modal component.ref="invoiceModal" invoice-context.bind="invoiceContext" original-document-type.two-way="selectedDocumentType"></invoice-modal>
<invoice-date-modal component.ref="invoiceDateModal" invoice-context.bind="invoiceContext" document-type.bind="selectedDocumentType"></invoice-date-modal>
<invoice-customer-modal component.ref="invoiceCustomerModal" invoice-context.bind="invoiceContext"></invoice-customer-modal>
<invoice-payment-modal component.ref="invoicePaymentModal" invoice-context.bind="invoiceContext"></invoice-payment-modal>
<invoice-attachment-modal component.ref="invoiceAttachmentModal" invoice-context.bind="invoiceContext"></invoice-attachment-modal>
<invoice-number-modal component.ref="invoiceNumberModal" invoice-context.bind="invoiceContext"></invoice-number-modal>
<validation-result-modal component.ref="validationResultModal"></validation-result-modal>

<div class="invoices-main">
    <div class="section-header">
        <div style="display:flex;align-items:center;gap:.5rem">
            <h1 if.bind="!readOnly" style="margin:0" t="invoice.new.${selectedDocumentType}">New Invoice/Credit-Note</h1>
            <h1 else style="margin:0; display: flex; align-items: center">
                <span t="documentType.${selectedDocumentType}"></span>
                <span style="margin-left: var(--space-05); margin-right: var(--space-05)" >${invoiceContext.selectedInvoice.ID}</span>
                <template if.bind="invoiceContext.selectedDocument">
                    <span class="pill" if.bind="invoiceContext.selectedDocument.draftedOn" t="invoice.status.draft">Drafted</span>
                    <span class="pill scheduled" if.bind="invoiceContext.selectedDocument.scheduledOn && !invoiceContext.selectedDocument.processedOn" t="invoice.status.scheduled">Scheduled</span>
                    <span class="pill processed" if.bind="invoiceContext.selectedDocument.processedOn && !invoiceContext.selectedDocument.processedStatus" t="invoice.status.processed">Processed</span>
                    <span class="pill error" if.bind="invoiceContext.selectedDocument.processedStatus" t="invoice.status.error" title.bind="invoiceContext.selectedDocument.processedStatus">Error</span>
                </template>
            </h1>
        </div>
        <div class="editor-header-actions">
            <button if.bind="!readOnly" type="button" class="btn" click.trigger="saveAsDraft()">
                <span if.bind="invoiceContext.selectedDraft" t="invoice.edit.update-draft">Update draft</span>
                <span if.bind="!invoiceContext.selectedDraft" t="invoice.edit.save-draft">Save draft</span>
            </button>
            <button if.bind="readOnly" type="button" class="btn" click.trigger="downloadUBL()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-down-icon lucide-file-down"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"/><path d="M14 2v5a1 1 0 0 0 1 1h5"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
                <span t="invoice.edit.download-ubl">UBL</span>
            </button>
            <button if.bind="invoiceContext.selectedDocument.id" type="button" class="btn" click.trigger="downloadPDF()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-down-icon lucide-file-down"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"/><path d="M14 2v5a1 1 0 0 0 1 1h5"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
                <span t="invoice.edit.download-pdf">PDF</span>
            </button>
            <button if.bind="readOnly && invoiceContext.partnerMissing" type="button" class="btn" click.trigger="savePartner()">Save Partner</button>
<!--            <button type="button" class="btn" click.trigger="validate()" t="invoice.edit.validate">Validate</button>-->
            <button if.bind="invoiceContext.selectedDraft && !readOnly" type="button" class="btn" click.trigger="deleteDraft()">
                <span t="invoice.edit.delete-draft">Delete draft</span>
            </button>
            <button type="button" class="btn" click.trigger="invoiceContext.clearSelectedInvoice()" t="invoice.edit.cancel">Cancel</button>
            <button if.bind="!readOnly" type="button" class="btn primary" click.trigger="verifyNumberAndSend()" disabled.bind="!isValid" t="invoice.edit.send.${selectedDocumentType}">Send invoice</button>
        </div>
    </div>

    <form id="invoiceForm" class="card composer-card">
        <div  class="composer-head">
            <invoice-info read-only.bind="readOnly" show-invoice-modal.bind="() => showInvoiceModal()"></invoice-info>

            <date-info read-only.bind="readOnly" show-date-modal.bind="() => showDateModal()"></date-info>

            <customer-info if.bind="invoiceContext.selectedDocument && invoiceContext.selectedDocument.direction === 'INCOMING'"
                           read-only.bind="readOnly"
                           party.bind="invoiceContext.selectedInvoice.AccountingSupplierParty.Party"
                           show-customer-modal.bind="() => showCustomerModal()">
            </customer-info>
            <customer-info else
                           read-only.bind="readOnly"
                           party.bind="invoiceContext.selectedInvoice.AccountingCustomerParty.Party"
                           show-customer-modal.bind="() => showCustomerModal()">
            </customer-info>

            <payment-info read-only.bind="readOnly" show-payment-modal.bind="() => showPaymentModal()" component.ref="paymentInfo"></payment-info>

            <attachment-info read-only.bind="readOnly" show-attachment-modal.bind="() => showAttachmentModal()"></attachment-info>

            <total-info read-only.bind="readOnly"></total-info>
        </div>

        <invoice-edit-items read-only.bind="readOnly" auto-save.bind="() => autoSave()"></invoice-edit-items>

        <button if.bind="!readOnly" type="button" class="btn primary" click.trigger="addLine()">+ <span t="invoice.edit.add-line">Add line</span></button>
        <div if.bind="invoiceContext.selectedInvoice.Note" style="margin-top: 20px">
            <div class="line-items-head">
                <h3 t="invoice.edit.note">Note</h3>
            </div>
            <label class="field">
                <textarea name="note" placeholder="Additional notes for this invoice" t="[placeholder]invoice.modal.note-placeholder" value.bind="invoiceContext.selectedInvoice.Note" disabled></textarea>
            </label>
        </div>
    </form>
</div>
